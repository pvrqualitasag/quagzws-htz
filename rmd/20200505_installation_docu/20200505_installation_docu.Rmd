---
title: "Installation Process of Dedicated Server with Hetzner"
author: "Peter von Rohr"
date: "5/5/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Disclaimer
The process when renting a new dedicated server with Hetzner is described. 


## Order
The server is ordered on the website https://www.hetzner.de/ under the `Dedicated`-Tab. We use the `Serverb√∂rse` to select the machine which suits our needs. After the order is placed, the order status is sent via E-Mail. As soon as the server is available, the ip-address of the server together with the root-password is sent via E-Mail. At the same time, the server also appears in the server-section of the Hetzner-Robot.  


## Image Installation
Follow https://wiki.hetzner.de/index.php/Installimage

First, the configuration file for the image installation is prepared and then uploaded to the server. 

```{r, eval=FALSE}
con_as_tmpl <- file(description = "input/installimage/autosetup.template")
vec_as_tmpl <- readLines(con = con_as_tmpl)
close(con_as_tmpl)
s_as_tmpl <- paste0(vec_as_tmpl, collapse = '\n')
HOSTNAME <- '2-htz.quagzws.com'
cat(glue::glue(s_as_tmpl), file = 'autosetup')
```

Upload the generated autosetup to the server

```{bash}
./bash/create_autosetup.sh -q 2-htz.quagzws.com
scp autosetup root@2-htz.quagzws.com:/
rm autosetup
```

Then we start the automatic setup on the new server with 

```
# ssh root@HOSTNAME
installimage -a -c /autosetup
```

The started command does the following points

* configuration of the disk-layout and the RAID-system
* setting of the hostname
* installation of the specified image.

As soon as the above installation process is finished, the server can be restarted. The server can be accessed via root and the password set by the rescue system. 


## Installation of System Software
The result of the `installimage` statement is a server with a minimal version of the operating system. After that we require more packages to be installed. Furthermore, we create an admin user and deny the user root to login via ssh. All this is done with an initialisation script. The first step is to copy the intialisation script to the new server. From the local machine, this is done with 

```
scp bash/init_htz.sh root@2-htz.quagzws.com:/root
```

On the server, we run the script with the command

```
./init_htz.sh -r <root_password> -u <admin_user> -p <admin_password>
# from the local machine
ssh root@2-htz.quagzws.com '/root/init_htz.sh -r <root_password> -u <admin_user> -p <admin_password>'
```

As the last step, we have to enable the firewall with the specified commands that are shown at the end of the script `init_htz.sh`.


## Installation of Applications
The server is mainly used for data science analyses. Hence it is clear that we need the basic data science tools. These tools are installed using the script `htz_install_app.sh`. The app-installation script is deployed via the github repository `quagzws-htz`. The first step is to clone the repository onto the new server. This can be done using `git` which is already installed. 

```
ssh quagadmin@2-htz.quagzws.com QUAGHTZROOT=/home/quagadmin/source;if [ ! -d "$QUAGHTZROOT" ];then mkdir -p $QUAGHTZROOT;fi cd $QUAGHTZROOT;git clone https://github.com/pvrqualitasag/quagzws-htz.git'
```

Once the repository is cloned, then we can start the app-installation script. Auf dem Server lassen wir das Skript als root laufen.

```
sudo su - -c'/home/quagadmin/source/quagzws-htz/bash/htz_install_app.sh'
```






## Generate Certificate






